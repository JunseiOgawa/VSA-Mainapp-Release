# VirtualLens Controllerガイド

VirtualLens Controllerは、VirtualLens2カメラの設定をリアルタイムで操作できる機能です。OSC（Open Sound Control）を通じてVRChat内のVirtualLens2アバターとの連携が可能です。

## VirtualLens Controllerの概要

VirtualLens Controllerを使用すると：

- **リアルタイム制御**: パラメータをリアルタイムでVRChatに反映
- **複数パラメータ対応**: 焦点距離、絞り、露出など複数の設定が可能
- **プリセット保存**: よく使う設定をプリセットとして保存
- **直感的なUI**: スライダーやノブで簡単に操作

## コントローラー画面へのアクセス

### メニューから開く

**手順**:
1. サイドバーメニュー（左側）を確認
2. 「コントローラー」という項目を探す
3. クリックしてコントローラー画面を開く

### キーボードショートカット

コントローラー画面には専用のショートカットキーがある場合があります。詳細は[キーボードショートカット](keyboard-shortcuts.md)を参照してください。

## コントローラー画面の使い方

### 画面構成

コントローラー画面は以下のセクションで構成されています：

- **パラメータセクション**: 各種カメラパラメータの設定
- **プリセットセクション**: プリセットの保存・読み込み
- **OSC状態表示**: 通信状態の確認
- **プレビュー**: 現在の設定がVRChatに反映されるリアルタイムプレビュー

### パラメータ設定

#### 焦点距離（Focal Length）

VirtualLens2のズーム設定に相当します。

**範囲**: 16mm ～ 300mm
**単位**: mm
**操作方法**:
- スライダーを左右にドラッグして調整
- 数値をダイレクト入力して指定
- 「リセット」ボタンで初期値（50mm）に戻す

**使用例**:
- 16mm: 広角撮影に適した設定
- 50mm: 標準的な人物撮影
- 200mm: 遠くの被写体を大きく捉える

#### 絞り値（Aperture）

画像の明るさと被写界深度（ボケ）を制御します。

**範囲**: F1.4 ～ F16
**単位**: F値
**操作方法**:
- スライダーを左右にドラッグ
- 数値をダイレクト入力
- 「リセット」ボタンで初期値（F4.0）に戻す

**使用例**:
- F1.4～F2.8: 背景がボケて被写体が強調される（ポートレート向き）
- F4.0～F8.0: バランスの取れた露出とボケ
- F11～F16: 全体的にシャープで背景もはっきり見える

#### 露出（Exposure）

画像全体の明るさを調整します。

**範囲**: -5.0 ～ +5.0
**単位**: EV（Exposure Value）
**操作方法**:
- スライダーを左右にドラッグ
- 数値をダイレクト入力
- 「自動」ボタンで自動露出に設定

**使用例**:
- -5.0～-2.0: 暗い環境での撮影（暗めに調整）
- 0.0: 標準的な露出
- +2.0～+5.0: 暗い場所をより明るく撮影

#### 被写界深度（Depth of Field）

ボケの強さを制御します。

**範囲**: 0 ～ 100
**操作方法**:
- スライダーを左右にドラッグ
- 数値をダイレクト入力

**使用例**:
- 0: ボケなし（全体がシャープ）
- 50: 中程度のボケ
- 100: 最大のボケ（背景が強くボケる）

### リアルタイム反映

各パラメータを変更すると、VRChat内のVirtualLens2カメラに即座に反映されます。

**確認方法**:
1. VRChatにてVirtualLens2を装備
2. コントローラー画面でパラメータを調整
3. VRChatの画面（ビューファインダー）で反映を確認

**注意事項**:
- OSC通信が正しく確立されている必要があります
- ネットワーク遅延により、反映に数フレームの遅延が生じる場合があります

## OSC通信設定

### OSCとは

OSC（Open Sound Control）は、ネットワークを通じてリアルタイムにパラメータを送受信するプロトコルです。VRChatとVSAの間で数値データを交換します。

### ポート設定

#### デフォルトポート

**デフォルト値**: 9001

VRChatの初期設定ではポート9001が使用されます。通常はこの設定で問題ありません。

#### ポート番号の変更

**変更が必要な場合**:
- ポート9001が別のアプリケーションで使用されている場合
- ネットワーク環境の要件で別のポートを指定する必要がある場合

**変更手順**:
1. コントローラー画面の「OSC設定」セクションを開く
2. 「ポート番号」フィールドに目的のポート番号を入力
3. 「適用」をクリック
4. VRChat側でも同じポート番号を設定してください

### 通信状態の確認

#### ステータス表示

コントローラー画面に通信状態が表示されます：

- **接続中（緑色）**: VRChatと正常に通信しています
- **切断（灰色）**: VRChatとの通信が確立されていません
- **エラー（赤色）**: 通信にエラーが発生しています

#### 診断方法

**手順**:
1. VRChatでVirtualLens2を装備
2. コントローラー画面を開く
3. ステータスが「接続中」になるまで待機
4. パラメータを1つ変更してみて、VRChatに反映するか確認

## プリセット管理

### プリセットとは

よく使うパラメータ設定（焦点距離、絞り、露出など）を組み合わせたセットをプリセットとして保存できます。

### プリセットの保存

**手順**:
1. 各パラメータを目的の値に調整
2. 「プリセット」セクションで「保存」ボタンをクリック
3. プリセット名を入力（例：「ポートレート」、「広角」）
4. 「保存」をクリック

### プリセットの読み込み

**手順**:
1. 「プリセット」セクションのリストから読み込みたいプリセットを選択
2. 「読み込み」ボタンをクリック
3. 保存されたパラメータ値がすべて適用されます
4. VRChatに自動的に反映されます

### プリセットの編集

**手順**:
1. プリセットを読み込む
2. パラメータを変更
3. 元のプリセット名の横にある「上書き」ボタンをクリック
4. 確認ダイアログで「上書き」をクリック

### プリセットの削除

**手順**:
1. 削除したいプリセットを選択
2. 「削除」ボタンをクリック
3. 確認ダイアログで「削除」をクリック

## VRChat側の設定

### VirtualLens2アバターの装備

VirtualLens Controllerを使用するには、VRChat内でVirtualLens2カメラが搭載されたアバターを装備する必要があります。

**確認方法**:
1. VRChatでアバターを装備
2. 表示 > ビューファインダー でVirtualLens2ビューファインダーが表示されるか確認

### OSCの有効化（VRChat側）

**VRChat設定手順**:
1. VRChatを起動
2. 設定 > OSC を開く
3. 「OSCを有効にする」をチェック
4. ポート番号が9001（またはVSA側で指定した値）に設定されているか確認
5. 設定を保存

### VirtualLens2パラメータの確認

VRChat内でVirtualLens2が以下のパラメータに対応しているか確認してください：

- `/avatar/parameters/VL2_FocalLength` - 焦点距離
- `/avatar/parameters/VL2_Aperture` - 絞り
- `/avatar/parameters/VL2_Exposure` - 露出
- `/avatar/parameters/VL2_DepthOfField` - 被写界深度

**確認方法**:
1. VRChat設定 > 開発者向け から詳細情報を表示
2. アバターパラメータリストを確認

## トラブルシューティング

### OSC通信が接続されない場合

**症状**: ステータスが「切断」のままになっている

**解決方法**:
1. VRChat側のOSC設定を確認
   - 「OSCを有効にする」がチェックされているか確認
   - ポート番号が一致しているか確認（デフォルト: 9001）
2. ファイアウォール設定を確認
   - Windowsファイアウォールが通信をブロックしていないか確認
   - セキュリティソフトの設定を確認
3. ポート番号が使用中でないか確認
   ```
   netstat -ano | findstr :9001
   ```
   - 他のプロセスがそのポート番号を使用している場合、別のポート番号に変更してください
4. VRChatとVSAを再起動
   - 両方とも完全に終了して再起動してください

### パラメータが反映されない場合

**症状**: コントローラーで値を変更しても、VRChat内で反映されない

**解決方法**:
1. 通信状態を確認
   - コントローラー画面のステータスが「接続中」か確認
   - 通信が「切断」の場合は上記の「OSC通信が接続されない場合」の解決方法を参照
2. VirtualLens2の装備を確認
   - VRChat内で正しいアバターを装備しているか確認
   - VirtualLens2ビューファインダーが表示されているか確認
3. パラメータ名を確認
   - アバター側で正しいパラメータ名が設定されているか確認
4. VSAを再起動
   - OSC接続をリセットするため、VSAを完全に再起動

### パラメータの反応が遅い場合

**症状**: コントローラーで値を変更してもVRChatに反映されるまでに遅延がある

**解決方法**:
1. ネットワーク接続を確認
   - インターネット接続の安定性を確認
   - Ping値を確認（`ping 127.0.0.1`）
2. 他のアプリケーションの負荷を確認
   - ネットワーク帯域を消費するアプリケーションを停止
   - CPU使用率が高くないか確認
3. VRChat側の処理負荷を確認
   - インスタンス内のプレイヤー数が多い場合、パフォーマンスが低下する可能性があります

### パラメータリセットが機能しない場合

**症状**: リセットボタンをクリックしても値が戻らない

**解決方法**:
1. パラメータの初期値設定を確認
   - リセット対象のパラメータが正しいか確認
2. アバター側の設定を確認
   - VirtualLens2の初期値設定がVRChat側で正しいか確認
3. コントローラーを再起動
   - コントローラー画面を閉じて再度開く

## 使用例

### 例1: ポートレート撮影用プリセット

**目的**: VRChat内で人物中心に撮影する

**設定**:
- 焦点距離: 85mm（人物向きの標準設定）
- 絞り: F2.0（背景がボケる）
- 露出: 0 EV（標準的な明るさ）
- 被写界深度: 80（背景をボケさせる）

**手順**:
1. 上記の値をコントローラーで設定
2. プリセット名「ポートレート」で保存
3. ポートレート撮影時に「読み込み」をクリック

### 例2: 風景撮影用プリセット

**目的**: ワールド全景を撮影する

**設定**:
- 焦点距離: 35mm（広角撮影）
- 絞り: F8.0（全体的にシャープ）
- 露出: 0.5 EV（若干明るめ）
- 被写界深度: 20（ボケは少なめ）

**手順**:
1. 上記の値をコントローラーで設定
2. プリセット名「風景」で保存
3. 風景撮影時に「読み込み」をクリック

### 例3: 夜間撮影用プリセット

**目的**: 暗いワールドで十分な明るさを確保する

**設定**:
- 焦点距離: 50mm（標準）
- 絞り: F1.4（最大の明るさ）
- 露出: +3.0 EV（明るく調整）
- 被写界深度: 50（中程度のボケ）

**手順**:
1. 上記の値をコントローラーで設定
2. プリセット名「夜間撮影」で保存
3. 夜間撮影時に「読み込み」をクリック

## 関連ドキュメント

- [VRChat連携](vrchat-integration.md) - VRChat連携の全般情報
- [ゲーム側設定ガイド](game-config.md) - OSC設定の詳細
- [キーボードショートカット](keyboard-shortcuts.md) - ショートカット一覧
