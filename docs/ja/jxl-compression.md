# JXL圧縮ガイド

VSAはJPEG XL（JXL）形式による画像圧縮機能を提供しています。このガイドでは、JXL圧縮の設定方法と使い方について説明します。

## JPEG XLとは

JPEG XLは次世代の画像フォーマットで、以下の特徴があります:

- **高い圧縮率**: PNGと比較して大幅にファイルサイズを削減
- **ロスレス圧縮**: 画質を劣化させずに圧縮可能
- **メタデータ保持**: VSAのメタデータを圧縮後も保持
- **可逆変換**: 元のPNGに完全に復元可能

VRChatのスクリーンショットは通常PNGで保存されますが、JXL圧縮により50%以上のサイズ削減が期待できます。

## 圧縮画面へのアクセス

サイドバーの「JXL圧縮」をクリックして、圧縮画面を開きます。

画面には2つのタブがあります:

- **自動圧縮**: スケジュールに基づく自動圧縮
- **手動圧縮**: 任意のタイミングで手動実行

## 自動圧縮

定期的に自動で圧縮を実行する機能です。

### スケジュール設定

| 設定項目 | 説明 |
|----------|------|
| 実行間隔 | 圧縮を実行する間隔（月単位） |
| 開始日 | 月のどの日から実行するか |
| 次回実行日 | 次にスケジュールされた実行日 |

### バックグラウンド処理設定

| 設定項目 | 説明 |
|----------|------|
| 自動開始 | 条件を満たしたら自動で開始 |
| 開始トリガー | 自動開始するファイル数の閾値 |
| 監視間隔 | フォルダを監視する間隔（分） |
| VRChat状態を考慮 | VRChat起動中は一時停止 |

### VRChat起動中の動作

「VRChat状態を考慮」を有効にすると、VRChatがアクティブな間は圧縮処理を一時停止します。これにより、ゲームプレイ中のパフォーマンス低下を防ぎます。

### スヌーズ機能

圧縮実行のリマインドが表示されたら、以下のスヌーズオプションを選択できます:

- 1時間後に再通知
- 翌日に再通知
- 1週間後に再通知
- 次の定期実行まで延期

## 手動圧縮

任意のフォルダを選択して圧縮を実行します。

### 操作手順

1. **入力フォルダを選択**: 圧縮するPNGファイルが含まれるフォルダ
2. **出力フォルダを選択**: JXLファイルの保存先
3. **処理モードを選択**: 一括処理またはバックグラウンド処理
4. **圧縮を開始**: 「圧縮開始」ボタンをクリック

### 処理モード

**一括処理:**
- 全ファイルを一度に処理
- 処理中はUIがビジー状態
- 処理完了まで待機

**バックグラウンド処理:**
- 低優先度で順次処理
- 他の操作を並行して実行可能
- 処理に時間がかかる

### 進捗の確認

処理中は以下の情報が表示されます:

- 処理済みファイル数 / 総ファイル数
- 進捗率（%）
- 現在処理中のファイル名

## JXLファイルの展開

圧縮したJXLファイルを元のPNGに戻すことができます。

1. 手動圧縮タブの「JXL展開」セクションを開く
2. 展開するJXLファイルまたはフォルダを選択
3. 出力先フォルダを選択
4. 「展開開始」をクリック

展開されたPNGファイルには、元のメタデータが復元されます。

## 圧縮設定

設定画面でJXL圧縮の詳細設定を変更できます。

### Effort（努力度）

| 値 | 説明 |
|----|------|
| 0-3 | 高速だが圧縮率は低い |
| 4-6 | バランス型 |
| 7-9 | 低速だが高圧縮率 |

デフォルト値は7で、圧縮率と処理速度のバランスが取れています。

### ロスレス圧縮

VSAではロスレス（可逆）圧縮のみをサポートしています。これにより:

- 画質が完全に保持される
- 元のPNGファイルに復元可能
- メタデータも保持される

## 圧縮結果

圧縮完了後、以下の情報が表示されます:

- 処理したファイル数
- 元のサイズ合計
- 圧縮後のサイズ合計
- 削減率（%）

また、各フォルダには `metadata.json` が生成され、圧縮履歴が記録されます。

## 注意事項

### VRChat起動中の圧縮

VRChatをプレイ中に圧縮を実行すると、以下の問題が発生する可能性があります:

- ゲームのパフォーマンス低下
- 写真撮影時の遅延
- まれにゲームがクラッシュ

可能な限り、VRChatを終了してから圧縮を実行することを推奨します。

### ディスク容量

圧縮処理中は、入力ファイルと出力ファイルの両方が存在するため、一時的に追加のディスク容量が必要です。

十分な空き容量（入力ファイルサイズの1.2倍程度）を確保してください。

### 元ファイルの扱い

圧縮後も元のPNGファイルは自動的に削除されません。ディスク容量を節約したい場合は、圧縮が正常に完了したことを確認してから手動で削除してください。

## バックグラウンド処理の詳細

### 自動開始メカニズム

バックグラウンド処理では、フォルダに新しい写真が追加されるのを監視し、条件を満たしたら自動的に圧縮を開始します。

**監視動作**:
- 監視間隔（デフォルト: 5分）で設定されたフォルダをスキャン
- 未処理のPNGファイル数が「開始トリガー」に達したら開始
- バックグラウンドで低優先度で処理

**設定例**:
- 監視間隔: 5分
- 開始トリガー: 10ファイル
- VRChat状態を考慮: 有効

この場合、5分ごとにフォルダをチェックし、未処理の写真が10枚以上あり、かつVRChatが起動していない場合に自動で圧縮が開始されます。

### バックグラウンド処理中の操作

処理中は以下の操作が可能です:

- ギャラリーの閲覧
- 写真の詳細表示
- お気に入りの登録/削除
- VRChatのプレイ
- その他の一般的な操作

処理の優先度が低いため、他の操作のパフォーマンスへの影響は最小限です。

## VRChat状態監視機能の詳細

### 監視対象

VSAは以下の状態を監視します:

- VRChatプロセスの起動/終了
- VRChatがアクティブ（フォーカス）かどうか

### 動作ロジック

「VRChat状態を考慮」が有効な場合:

1. VRChatプロセスが存在する → 圧縮は一時停止
2. VRChatプロセスが終了する → 圧縮を再開
3. VRChatがアクティブ → パフォーマンス警告を表示

### パフォーマンスへの影響

- VRChatプレイ中の圧縮は、ゲームのフレームレートを低下させる可能性
- ゲーム中に圧縮を実行する必要がある場合、バックグラウンド処理を使用
- それでもパフォーマンス低下が気になる場合は、ゲーム終了後に実行することを推奨

## スケジュール設定の実例

### 例1: 毎月1回、月初に自動圧縮

```
実行間隔: 毎月（1ヶ月間隔）
開始日: 1日
自動開始: 有効
開始トリガー: 5ファイル
```

この設定では:
- 毎月1日に自動圧縮がスケジュール
- 5枚以上の未処理写真がある場合のみ開始
- VRChat起動中は一時停止して再開待機

### 例2: 週2回、火曜日と金曜日に実行

```
実行間隔: 3日（約1週間の2回）
開始日: 火曜日
```

実装上の注意: 現在のスケジュール機能では「特定の曜日」の直接指定はできません。開始日を決めて、実行間隔で調整してください。

## トラブルシューティング

### 圧縮が進まない

1. **ディスク容量を確認**: 十分な空き容量があるか
2. **ファイルのアクセス権を確認**: 読み取り/書き込み権限があるか
3. **対象ファイルを確認**: PNGファイルが存在するか

### 圧縮率が低い

すでに効率的に圧縮されている画像や、単純な内容の画像は圧縮率が低くなる場合があります。

### メタデータが消えた

JXL形式以外で保存すると、VSAのメタデータが失われる場合があります。必ずVSAの圧縮機能を使用してください。
